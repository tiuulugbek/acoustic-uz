// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  password           String
  fullName           String?
  roleId             String
  role               Role     @relation(fields: [roleId], references: [id], onDelete: Restrict)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(false)

  @@index([email])
  @@index([roleId])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // superadmin, admin, editor, viewer
  permissions String[] // granular keys
  users       User[]

  @@index([name])
}

model Media {
  id        String   @id @default(cuid())
  url       String
  alt_uz    String?
  alt_ru    String?
  filename  String?
  mimeType  String?
  size      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  banners             Banner[]
  services            Service[]       @relation("ServiceCover")
  servicesAlternative Service[]       @relation("ServiceAlternativeCover")
  brands              Brand[]
  posts               Post[]
  branches            Branch[]
  homepageHearingAids HomepageHearingAid[]
  homepageServices    HomepageService[]
  productCategories   ProductCategory[]
  serviceCategories   ServiceCategory[]
  postCategories      PostCategory[]
  catalogs            Catalog[]
  doctors             Doctor[]
  settingsCatalogHero Setting? @relation("SettingCatalogHero")
  settingsLogo        Setting? @relation("SettingLogo")
  settingsFavicon     Setting? @relation("SettingFavicon")
  homepagePlaceholders HomepagePlaceholder[]

  @@index([url])
}

model Setting {
  id                 String   @id @default("singleton")
  phonePrimary       String?  @default("1385")
  phoneSecondary     String?  @default("+998 71 202 14 41")
  email              String?
  telegramBotToken   String?  // Bot token for forms (sends to Telegram)
  telegramChatId     String?  // Chat ID for forms bot
  telegramButtonBotToken String?  // Bot token for Telegram button
  telegramButtonBotUsername String?  // Bot username for Telegram button (e.g., @yourbot)
  telegramButtonMessage_uz String?  // Message shown in chat bubble (Uzbek)
  telegramButtonMessage_ru String?  // Message shown in chat bubble (Russian)
  brandPrimary       String?  @default("#F07E22")
  brandAccent        String?  @default("#3F3091")
  featureFlags       Json? // see §11
  socialLinks        Json? // { facebook, instagram, telegram, etc. }
  googleAnalyticsId  String?  // Google Analytics 4 Measurement ID (e.g., G-XXXXXXXXXX)
  yandexMetrikaId    String?  // Yandex Metrika Counter ID (e.g., 12345678)
  catalogHeroImageId String?  @unique
  catalogHeroImage   Media?   @relation("SettingCatalogHero", fields: [catalogHeroImageId], references: [id], onDelete: SetNull)
  logoId             String?  @unique
  logo               Media?   @relation("SettingLogo", fields: [logoId], references: [id], onDelete: SetNull)
  faviconId          String?  @unique
  favicon            Media?   @relation("SettingFavicon", fields: [faviconId], references: [id], onDelete: SetNull)
  // Sidebar settings - per page type
  sidebarConfigs     Json? // { catalog: { sections: [...], brandIds: [...] }, products: {...}, services: {...}, posts: {...} }
  // Legacy sidebar settings (for backward compatibility)
  sidebarSections    Json? // Array of { id, title_uz, title_ru, link, icon, imageId, order }
  sidebarBrandIds    String[] @default([]) // Array of Brand IDs to show in sidebar
  updatedAt          DateTime @updatedAt
}

model Banner {
  id         String   @id @default(cuid())
  title_uz   String
  title_ru   String
  text_uz    String?
  text_ru    String?
  ctaText_uz String?
  ctaText_ru String?
  ctaLink    String?
  imageId    String?
  image      Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  order      Int      @default(0)
  status     String   @default("published") // published, draft, archived
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status, order])
}

model ServiceCategory {
  id             String            @id @default(cuid())
  name_uz        String
  name_ru        String
  slug           String            @unique
  description_uz String?
  description_ru String?
  icon           String?
  imageId        String?
  image          Media?            @relation(fields: [imageId], references: [id], onDelete: SetNull)
  parentId       String?
  parent         ServiceCategory?  @relation("ServiceCategoryToParent", fields: [parentId], references: [id], onDelete: Cascade)
  children       ServiceCategory[] @relation("ServiceCategoryToParent")
  services       Service[]
  order          Int               @default(0)
  status         String            @default("published")
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([slug])
  @@index([parentId])
  @@index([order])
  @@index([status])
}

model Service {
  id                String           @id @default(cuid())
  title_uz          String
  title_ru          String
  excerpt_uz        String?
  excerpt_ru        String?
  body_uz           String?
  body_ru           String?
  slug              String           @unique
  categoryId        String?
  category          ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  coverId           String?
  cover             Media?           @relation("ServiceCover", fields: [coverId], references: [id], onDelete: SetNull)
  alternativeCoverId String?
  alternativeCover  Media?           @relation("ServiceAlternativeCover", fields: [alternativeCoverId], references: [id], onDelete: SetNull)
  order             Int              @default(0)
  status            String           @default("published")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([slug])
  @@index([categoryId])
  @@index([status, order])
}

model Brand {
  id       String    @id @default(cuid())
  name     String    @unique
  slug     String    @unique
  logoId   String?
  logo     Media?    @relation(fields: [logoId], references: [id], onDelete: SetNull)
  desc_uz  String?
  desc_ru  String?
  products Product[]

  @@index([slug])
}

model ProductCategory {
  id             String            @id @default(cuid())
  name_uz        String
  name_ru        String
  slug           String            @unique
  description_uz String?
  description_ru String?
  icon           String?
  imageId        String?
  image          Media?            @relation(fields: [imageId], references: [id], onDelete: SetNull)
  parentId       String?
  parent         ProductCategory?  @relation("CategoryToParent", fields: [parentId], references: [id], onDelete: Cascade)
  children       ProductCategory[] @relation("CategoryToParent")
  products       Product[]
  order          Int               @default(0)

  @@index([slug])
  @@index([parentId])
  @@index([order])
}

model Catalog {
  id             String    @id @default(cuid())
  name_uz        String
  name_ru        String
  slug           String    @unique
  description_uz String?
  description_ru String?
  icon           String?
  imageId        String?
  image          Media?    @relation(fields: [imageId], references: [id], onDelete: SetNull)
  products       Product[] @relation("ProductToCatalog")
  order          Int       @default(0)
  status         String    @default("published") // published, draft, archived
  showOnHomepage Boolean   @default(false) // Bosh sahifada ko'rsatish

  @@index([slug])
  @@index([order])
  @@index([status])
  @@index([showOnHomepage])
}

model Product {
  id                      String           @id @default(cuid())
  name_uz                 String
  name_ru                 String
  slug                    String           @unique
  productType             String? // hearing-aids, accessories, interacoustics
  description_uz          String?          @db.Text
  description_ru          String?          @db.Text
  price                   Decimal?         @db.Decimal(14, 2)
  stock                   Int?             @default(0)
  brandId                 String?
  brand                   Brand?           @relation(fields: [brandId], references: [id], onDelete: SetNull)
  categoryId              String?
  category                ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  catalogs                Catalog[]        @relation("ProductToCatalog")
  specsText               String?          @db.Text
  galleryIds              String[] // Array of Media IDs
  thumbnailId             String? // Main thumbnail Media ID
  audience                String[]         @default([])
  formFactors             String[]         @default([])
  signalProcessing        String?
  powerLevel              String?
  hearingLossLevels       String[]         @default([])
  smartphoneCompatibility String[]         @default([])
  tinnitusSupport         Boolean?         @default(false)
  paymentOptions          String[]         @default([])
  availabilityStatus      String?
  intro_uz                String?          @db.Text
  intro_ru                String?          @db.Text
  features_uz             String[]         @default([])
  features_ru             String[]         @default([])
  benefits_uz             String[]         @default([])
  benefits_ru             String[]         @default([])
  tech_uz                 String?          @db.Text
  tech_ru                 String?          @db.Text
  fittingRange_uz         String?          @db.Text
  fittingRange_ru         String?          @db.Text
  regulatoryNote_uz       String?          @db.Text
  regulatoryNote_ru       String?          @db.Text
  galleryUrls             String[]         @default([])
  relatedProductIds       String[]         @default([])
  usefulArticleSlugs      String[]         @default([])
  status                  String           @default("published")
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  @@index([slug])
  @@index([brandId])
  @@index([categoryId])
  @@index([status])
  @@index([productType])
}

model Showcase {
  id                String   @id @default(cuid())
  type              String   @unique // "interacoustics" or "cochlear"
  productIds       String[] // Array of Product IDs in order
  productMetadata  Json?    // { [productId]: { description_uz, description_ru, imageId } }
  updatedAt         DateTime @updatedAt
}

model PostCategory {
  id          String   @id @default(cuid())
  name_uz     String
  name_ru     String
  slug        String   @unique
  description_uz String? @db.Text
  description_ru String? @db.Text
  section     String?  // "patients" or "children" - which section this category belongs to
  imageId     String?  @unique
  image       Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  order       Int      @default(0)
  status      String   @default("published")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]

  @@index([slug])
  @@index([status, order])
  @@index([section])
}

model Post {
  id                String             @id @default(cuid())
  title_uz          String
  title_ru          String
  body_uz           String             @db.Text
  body_ru           String             @db.Text
  slug              String             @unique
  excerpt_uz        String?            @db.Text
  excerpt_ru        String?            @db.Text
  coverId           String?
  cover             Media?             @relation(fields: [coverId], references: [id], onDelete: SetNull)
  postType          String             @default("article") // "article" or "news"
  categoryId        String?
  category          PostCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  authorId          String?
  author            Doctor?            @relation(fields: [authorId], references: [id], onDelete: SetNull)
  tags              String[]
  status            String             @default("published")
  publishAt         DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  homepageNewsItems HomepageNewsItem[]

  @@index([slug])
  @@index([status, publishAt])
  @@index([tags])
  @@index([categoryId])
  @@index([categoryId, status])
  @@index([postType])
  @@index([authorId])
}

model Faq {
  id          String   @id @default(cuid())
  question_uz String
  question_ru String
  answer_uz   String   @db.Text
  answer_ru   String   @db.Text
  order       Int      @default(0)
  status      String   @default("published")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, order])
}

model Branch {
  id             String   @id @default(cuid())
  name_uz        String
  name_ru        String
  slug           String?  @unique
  address_uz     String
  address_ru     String
  phone          String
  phones         String[] // Additional phones
  imageId        String?
  image          Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  map_iframe     String?  @db.Text
  tour3d_iframe  String?  @db.Text // 3D virtual tour iframe (legacy, for backward compatibility)
  tour3d_config  Json?    // 3D virtual tour configuration (Pannellum-based tour config)
  latitude       Float?   // GPS latitude
  longitude      Float?   // GPS longitude
  workingHours_uz String? @db.Text // Ish vaqti (uzbek) - Masalan: "Dushanba - Juma: 09:00-20:00\nShanba - Yakshanba: 09:00-18:00"
  workingHours_ru String? @db.Text // Ish vaqti (russian) - Masalan: "Понедельник - Пятница: 09:00-20:00\nСуббота - Воскресенье: 09:00-18:00"
  serviceIds     String[] @default([]) // Xizmatlar ID'lari array'i
  order          Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([slug])
  @@index([order])
}

model Page {
  id                 String   @id @default(cuid())
  slug               String   @unique
  title_uz           String
  title_ru           String
  body_uz            String?  @db.Text
  body_ru            String?  @db.Text
  metaTitle_uz       String?
  metaTitle_ru       String?
  metaDescription_uz String?
  metaDescription_ru String?
  galleryIds         String[] @default([]) // Array of Media IDs for image gallery
  videoUrl           String?  // YouTube video URL
  usefulArticleSlugs String[] @default([]) // Array of Post slugs for useful articles sidebar
  status             String   @default("published")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([slug])
  @@index([status])
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  phone     String
  email     String?
  source    String? // Form source: "home", "contact", "product", etc.
  message   String?  @db.Text
  productId String? // If from product page
  status    String   @default("new") // new, contacted, converted, archived
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([source])
}

model HearingTest {
  id              String   @id @default(cuid())
  name            String?  // Foydalanuvchi ismi (ixtiyoriy)
  phone           String?  // Telefon raqami (ixtiyoriy)
  email           String?  // Email (ixtiyoriy)
  
  // Test sozlamalari
  deviceType      String   // "speaker" yoki "headphone"
  volumeLevel     Float?   // Ovoz balandligi (0-1)
  testMethod      String?  @default("frequency") // "frequency" yoki "digits-in-noise"
  
  // Frequency test natijalari (eski metod)
  leftEarResults  Json?    // { "250": 0.5, "500": 0.3, ... } - volume levels
  rightEarResults Json?    // { "250": 0.5, "500": 0.3, ... } - volume levels
  
  // Digits-in-Noise test natijalari (yangi metod)
  leftEarSRT      Float?   // SRT-50 in dB (chap quloq)
  rightEarSRT     Float?   // SRT-50 in dB (o'ng quloq)
  overallSRT      Float?   // Umumiy SRT-50 in dB
  leftEarSINResults  Json? // To'liq SIN test natijalari (reversals, responses, etc.)
  rightEarSINResults Json? // To'liq SIN test natijalari (reversals, responses, etc.)
  
  // Hisoblangan natijalar
  leftEarScore    Int?     // 0-100 (foiz)
  rightEarScore   Int?     // 0-100 (foiz)
  overallScore    Int?     // 0-100 (foiz)
  
  // Eshitish darajasi
  leftEarLevel    String?  // "normal", "mild", "moderate", "severe", "profound"
  rightEarLevel   String?  // "normal", "mild", "moderate", "severe", "profound"
  
  // Qo'shimcha ma'lumotlar
  source          String   @default("hearing_test")
  status          String   @default("completed") // "completed", "contacted", "converted"
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, createdAt])
  @@index([source])
  @@index([testMethod])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userEmail String?
  entity    String // Model name
  entityId  String // Model ID
  action    String // create, update, delete
  changes   Json? // Diff snapshot
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model Menu {
  id        String   @id @default(cuid())
  name      String   @unique // "header" or "footer"
  items     Json // Menu items structure
  updatedAt DateTime @updatedAt
}

model HomepageHearingAid {
  id             String   @id @default(cuid())
  title_uz       String
  title_ru       String
  description_uz String?
  description_ru String?
  link           String?
  imageId        String?
  image          Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  order          Int      @default(0)
  status         String   @default("published")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status, order])
}

model HomepageJourneyStep {
  id             String   @id @default(cuid())
  title_uz       String
  title_ru       String
  description_uz String?
  description_ru String?
  order          Int      @default(0)
  status         String   @default("published")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status, order])
}

model HomepageNewsItem {
  id          String    @id @default(cuid())
  postId      String?
  post        Post?     @relation(fields: [postId], references: [id], onDelete: SetNull)
  title_uz    String
  title_ru    String
  excerpt_uz  String?
  excerpt_ru  String?
  slug        String?
  publishedAt DateTime?
  order       Int       @default(0)
  status      String    @default("published")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([status, order])
  @@index([postId])
}

model HomepageService {
  id         String   @id @default(cuid())
  title_uz   String
  title_ru   String
  excerpt_uz String?
  excerpt_ru String?
  slug       String?
  imageId    String?
  image      Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  order      Int      @default(0)
  status     String   @default("published")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([status, order])
}

model Doctor {
  id             String   @id @default(cuid())
  name_uz        String
  name_ru        String
  position_uz    String?
  position_ru    String?
  experience_uz  String?
  experience_ru  String?
  description_uz String?  @db.Text
  description_ru String?  @db.Text
  slug           String   @unique
  imageId        String?
  image          Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  branchIds      String[] @default([]) // Array of Branch IDs where doctor accepts patients
  patientTypes   String[] @default([]) // ["adults", "children"] or ["adults"] or ["children"]
  order          Int      @default(0)
  status         String   @default("published") // published, draft, archived
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  posts          Post[]

  @@index([slug])
  @@index([status, order])
}

model HomepageSection {
  id              String   @id @default(cuid())
  key             String   @unique
  title_uz        String?
  title_ru        String?
  subtitle_uz     String?
  subtitle_ru     String?
  description_uz  String?  @db.Text
  description_ru  String?  @db.Text
  showTitle       Boolean  @default(true)
  showSubtitle    Boolean  @default(false)
  showDescription Boolean  @default(false)
  order           Int      @default(0)
  status          String   @default("published") // published, draft, hidden
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([key])
  @@index([status, order])
}

model HomepageLink {
  id         String   @id @default(cuid())
  sectionKey String
  text_uz    String
  text_ru    String
  href       String
  icon       String?
  position   String   @default("bottom") // bottom, header, inline
  order      Int      @default(0)
  status     String   @default("published") // published, draft
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([sectionKey])
  @@index([position, order])
  @@index([status])
}

model HomepagePlaceholder {
  id            String   @id @default(cuid())
  sectionKey    String   @unique
  text_uz       String?
  text_ru       String?
  backgroundColor String?
  textColor     String?
  fontSize      String?
  fontWeight    String?
  imageId       String?
  image         Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sectionKey])
}

model HomepageEmptyState {
  id         String   @id @default(cuid())
  sectionKey String   @unique
  message_uz String
  message_ru String
  icon       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([sectionKey])
}

model CatalogPageConfig {
  id                  String   @id @default("singleton")
  hearingAidsTitle_uz String?
  hearingAidsTitle_ru String?
  interacousticsTitle_uz String?
  interacousticsTitle_ru String?
  accessoriesTitle_uz String?
  accessoriesTitle_ru String?
  updatedAt          DateTime @updatedAt
}

model CommonText {
  id        String   @id @default(cuid())
  key       String   @unique
  text_uz   String
  text_ru   String
  category  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([category])
}

model AvailabilityStatus {
  id         String   @id @default(cuid())
  key        String   @unique
  label_uz   String
  label_ru   String
  schema     String?  // Schema.org URL
  colorClass String?  // Tailwind CSS classes
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([key])
  @@index([order])
}

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  fullName  String?
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Restrict)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)
  mustChangePassword Boolean @default(false)

  @@index([email])
  @@index([roleId])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // superadmin, admin, editor, viewer
  permissions String[] // granular keys
  users       User[]

  @@index([name])
}

model Media {
  id        String   @id @default(cuid())
  url       String
  alt_uz    String?
  alt_ru    String?
  filename  String?
  mimeType  String?
  size      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  banners  Banner[]
  services Service[]
  brands   Brand[]
  posts    Post[]
  branches Branch[]
  homepageHearingAids HomepageHearingAid[]
  productCategories ProductCategory[]

  @@index([url])
}

model Setting {
  id                String  @id @default("singleton")
  phonePrimary      String? @default("1385")
  phoneSecondary    String? @default("+998 71 202 14 41")
  email             String?
  telegramBotToken  String?
  telegramChatId    String?
  brandPrimary      String? @default("#F07E22")
  brandAccent       String? @default("#3F3091")
  featureFlags      Json?   // see ยง11
  socialLinks       Json?   // { facebook, instagram, telegram, etc. }
  updatedAt         DateTime @updatedAt
}

model Banner {
  id        String   @id @default(cuid())
  title_uz  String
  title_ru  String
  text_uz   String?
  text_ru   String?
  ctaText_uz String?
  ctaText_ru String?
  ctaLink   String?
  imageId   String?
  image     Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  order     Int      @default(0)
  status    String   @default("published") // published, draft, archived
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, order])
}

model Service {
  id          String   @id @default(cuid())
  title_uz    String
  title_ru    String
  excerpt_uz  String?
  excerpt_ru  String?
  body_uz     String?
  body_ru     String?
  slug        String   @unique
  coverId     String?
  cover       Media?   @relation(fields: [coverId], references: [id], onDelete: SetNull)
  order       Int      @default(0)
  status      String   @default("published")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([status, order])
}

model Brand {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  logoId    String?
  logo      Media?   @relation(fields: [logoId], references: [id], onDelete: SetNull)
  desc_uz   String?
  desc_ru   String?
  products  Product[]

  @@index([slug])
}

model ProductCategory {
  id            String   @id @default(cuid())
  name_uz       String
  name_ru       String
  slug          String   @unique
  description_uz String?
  description_ru String?
  icon          String?
  imageId       String?
  image         Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  parentId      String?
  parent        ProductCategory? @relation("CategoryToParent", fields: [parentId], references: [id], onDelete: Cascade)
  children      ProductCategory[] @relation("CategoryToParent")
  products      Product[]
  order         Int      @default(0)

  @@index([slug])
  @@index([parentId])
  @@index([order])
}

model Product {
  id            String   @id @default(cuid())
  name_uz       String
  name_ru       String
  slug          String   @unique
  description_uz String? @db.Text
  description_ru String? @db.Text
  price         Decimal? @db.Decimal(14, 2)
  stock         Int?     @default(0)
  brandId       String?
  brand         Brand?   @relation(fields: [brandId], references: [id], onDelete: SetNull)
  categoryId    String?
  category      ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  specsText     String? @db.Text
  galleryIds    String[] // Array of Media IDs
  audience      String[] @default([])
  formFactors   String[] @default([])
  signalProcessing String?
  powerLevel    String?
  hearingLossLevels String[] @default([])
  smartphoneCompatibility String[] @default([])
  tinnitusSupport Boolean? @default(false)
  paymentOptions String[] @default([])
  availabilityStatus String?
  intro_uz      String? @db.Text
  intro_ru      String? @db.Text
  features_uz   String[] @default([])
  features_ru   String[] @default([])
  benefits_uz   String[] @default([])
  benefits_ru   String[] @default([])
  tech_uz       String? @db.Text
  tech_ru       String? @db.Text
  fittingRange_uz String? @db.Text
  fittingRange_ru String? @db.Text
  regulatoryNote_uz String? @db.Text
  regulatoryNote_ru String? @db.Text
  galleryUrls   String[] @default([])
  relatedProductIds String[] @default([])
  usefulArticleSlugs String[] @default([])
  status        String   @default("published")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([brandId])
  @@index([categoryId])
  @@index([status])
}

model Showcase {
  id        String   @id @default(cuid())
  type      String   @unique // "interacoustics" or "cochlear"
  productIds String[] // Array of Product IDs in order
  updatedAt DateTime @updatedAt
}

model Post {
  id        String   @id @default(cuid())
  title_uz  String
  title_ru  String
  body_uz   String   @db.Text
  body_ru   String   @db.Text
  slug      String   @unique
  excerpt_uz String? @db.Text
  excerpt_ru String? @db.Text
  coverId   String?
  cover     Media?   @relation(fields: [coverId], references: [id], onDelete: SetNull)
  tags      String[]
  status    String   @default("published")
  publishAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  homepageNewsItems HomepageNewsItem[]

  @@index([slug])
  @@index([status, publishAt])
  @@index([tags])
}

model Faq {
  id          String   @id @default(cuid())
  question_uz String
  question_ru String
  answer_uz   String   @db.Text
  answer_ru   String   @db.Text
  order       Int      @default(0)
  status      String   @default("published")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status, order])
}

model Branch {
  id          String   @id @default(cuid())
  name_uz     String
  name_ru     String
  address_uz  String
  address_ru  String
  phone       String
  phones      String[] // Additional phones
  imageId     String?
  image       Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  map_iframe  String?  @db.Text
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

model Page {
  id        String   @id @default(cuid())
  slug      String   @unique
  title_uz  String
  title_ru  String
  body_uz   String?  @db.Text
  body_ru   String?  @db.Text
  metaTitle_uz String?
  metaTitle_ru String?
  metaDescription_uz String?
  metaDescription_ru String?
  status    String   @default("published")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  phone     String
  email     String?
  source    String?  // Form source: "home", "contact", "product", etc.
  message   String?  @db.Text
  productId String?  // If from product page
  status    String   @default("new") // new, contacted, converted, archived
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, createdAt])
  @@index([source])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  userEmail String?
  entity    String   // Model name
  entityId  String   // Model ID
  action    String   // create, update, delete
  changes   Json?    // Diff snapshot
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

model Menu {
  id        String   @id @default(cuid())
  name      String   @unique // "header" or "footer"
  items     Json     // Menu items structure
  updatedAt DateTime @updatedAt
}

model HomepageHearingAid {
  id             String   @id @default(cuid())
  title_uz       String
  title_ru       String
  description_uz String?
  description_ru String?
  link           String?
  imageId        String?
  image          Media?   @relation(fields: [imageId], references: [id], onDelete: SetNull)
  order          Int      @default(0)
  status         String   @default("published")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status, order])
}

model HomepageJourneyStep {
  id             String   @id @default(cuid())
  title_uz       String
  title_ru       String
  description_uz String?
  description_ru String?
  order          Int      @default(0)
  status         String   @default("published")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status, order])
}

model HomepageNewsItem {
  id           String   @id @default(cuid())
  postId       String?
  post         Post?    @relation(fields: [postId], references: [id], onDelete: SetNull)
  title_uz     String
  title_ru     String
  excerpt_uz   String?
  excerpt_ru   String?
  slug         String?
  publishedAt  DateTime?
  order        Int      @default(0)
  status       String   @default("published")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status, order])
  @@index([postId])
}

